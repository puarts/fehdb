"""過剰分割された行のマージ処理

VLMがゲーム画面のテキスト折り返し（word wrap）と論理的な段落改行を混同し、
過剰に行分割してしまう問題を後処理で修正する。

行頭パターンのホワイトリストで「この行は独立した行か」を判定し、
該当しない行を前行にマージする。
"""

import logging
import re

logger = logging.getLogger(__name__)

# 独立した行の開始パターン（これらで始まる行は前行にマージしない）
LINE_START_PATTERNS: list[str] = [
    # 特効
    r'^飛行特効',
    r'^竜特効',
    r'^重装',  # 重装特効, 重装、騎馬特効
    r'^騎馬特効',
    r'^魔法特効',
    # 奥義
    r'^奥義',  # 奥義が発動しやすい, 奥義発動時, 奥義を発動, 奥義で同時に
    # タイミング系
    r'^ターン開始時',
    r'^自軍ターン',  # 自軍ターン開始時, 自軍ターンのターン開始時
    r'^自車',  # OCR誤認識の自軍ターン/自軍内
    r'^敵軍(の)?ターン',  # 敵軍ターン開始時, 敵軍のターン開始時
    r'^戦闘(中|開始(時|後)|後|相手)',  # 戦闘中, 戦闘開始時, 戦闘開始後, 戦闘後, 戦闘相手
    r'^行動後',
    r'^現在の',  # 現在のターン中に...
    # 自分系（攻撃、化身、条件等すべて）
    r'^自分',  # 自分から攻撃, 自分と, 自分が化身, 自分に, 自分を, 自分または, 自分、
    # 自身系
    r'^自身',  # 自身を中心, 自身のHP, 自身の戦闘順, 自身の奥義
    # 敵系
    r'^敵(は|の|を|が|から|軍)',  # 敵は, 敵の, 敵を, 敵が, 敵から攻撃, 敵軍
    # 味方・支援系
    r'^味方',  # 味方が自分から攻撃した戦闘後, 味方の隣接マス
    r'^支援',  # 支援相手
    # 移動・範囲
    r'^【',  # 【再移動, 【暗器, 【七難即滅】等すべての隅付き括弧
    r'^周囲\d+マス',
    r'^射程[12]の',
    r'^再移動時',
    r'^飛空城',  # 飛空城防衛, 飛空城で攻撃時
    r'^マップ上',  # マップ上の, マップ上に
    r'^ロキ',  # ロキの盤上遊戯を除く
    # スキル関連
    r'^下記の',  # 下記の【スタイル】, 下記の条件
    r'^杖は他の武器同様',
    r'^応援',
    r'^この',  # このスキル, このスタイル
    r'^スキル',  # スキル効果の射程
    r'^補助スキル',
    r'^移動系補助',
    r'^対象',  # 対象を行動可能な状態にし...
    r'^後述',  # 後述の対象
    r'^追撃',  # 追撃の速さ条件
    # 状態・条件
    r'^化身(状態|時)',
    r'^無属性',
    r'^自軍内',
    r'^[赤青緑]属性',  # 赤属性、青属性、緑属性の敵
    r'^神竜',  # 神竜の花を自身に
    # ステータス行
    r'^(攻撃|速さ|守備|魔防|HP)',  # 任意のステータス名で始まる行
    r'^ダメージ',  # ダメージ+攻撃の20%
    r'^与える',  # 与えるダメージ
    r'^受けた',  # 受けた範囲奥義のダメージ
    r'^強化',
    r'^減少',  # 減少値は
    # 接続語（独立した効果の追加）
    r'^さらに',  # さらに、敵の奥義による攻撃で
    r'^かつ',  # かつ、魔防が敵より高い時
    r'^その',  # その状態で攻撃した時
    # 数値始まり
    r'^\d',  # 2回攻撃, 20以上なら, 1~4ターン目, 2マス離れた
    # 補足・括弧・記号
    r'^（',  # （この, （いずれも, （条件A 等
    r'^「',  # 「歌う」「踊る」, 「自分または敵が...
    r'^・',  # 箇条書き
    r'^―',  # ―【スタイル】：射程2―
    # その他
    r'^竜、',  # 竜、獣の味方は
]

_compiled_patterns: list[re.Pattern[str]] = [re.compile(p) for p in LINE_START_PATTERNS]


def _is_line_start(line: str) -> bool:
    """行が独立した行の開始パターンにマッチするか判定"""
    return any(p.search(line) for p in _compiled_patterns)


def merge_lines(lines: list[str]) -> list[str]:
    """過剰分割された行をマージする

    VLMが画面のword wrapで誤分割した行を、行頭パターンに基づいて結合する。
    1行目は常にそのまま保持し、2行目以降は行頭パターンにマッチしなければ
    前行に結合する。
    """
    if len(lines) <= 1:
        return lines
    merged: list[str] = [lines[0]]
    for line in lines[1:]:
        stripped = line.strip()
        if not stripped:
            continue
        if _is_line_start(stripped):
            merged.append(stripped)
        else:
            merged[-1] = merged[-1] + stripped
    if len(merged) != len(lines):
        logger.info("[行マージ] %d行 → %d行", len(lines), len(merged))
    return merged
